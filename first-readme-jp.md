🤷‍♂️ GIT - その「くだらない」コンテンツトラッカー
「git」の定義
「git」は、気分によって何でも意味し得ます。

発音可能な3文字のランダムな組み合わせで、一般的なUNIXコマンドでは実際には使用されていないこと。「get」の誤発音であるという事実は、関連があるかもしれないし、ないかもしれません。

くだらない。軽蔑すべき、卑劣な、単純な。スラング辞書から好きなものを選んでください。

「global information tracker」（グローバル情報トラッカー）：あなたが上機嫌で、実際にそれがうまく機能しているとき。天使が歌い、部屋が突然光で満たされます。

「goddamn idiotic truckload of sh*t」（忌々しい馬鹿げた大量のクソ）：それが壊れたとき。

これは、くだらない（しかし非常に高速な）ディレクトリコンテンツマネージャーです。大したことはしませんが、ディレクトリの内容を効率的に追跡することはします。

ここには2つのオブジェクトの抽象化があります。「オブジェクトデータベース」と「現在のディレクトリキャッシュ」です。

💾 オブジェクトデータベース（SHA1_FILE_DIRECTORY）
オブジェクトデータベースは、文字通りコンテンツアドレス指定可能なオブジェクトのコレクションです。すべてのオブジェクトは、それ自体のSHA1ハッシュによって近似される内容によって命名されます。オブジェクトは他のオブジェクトを参照（それらのSHA1ハッシュを参照）することができ、それによってオブジェクトの階層を構築できます。

コンテンツアドレス指定可能なコレクションデータベースにはいくつかの種類のオブジェクトがあります。それらはすべてzlibでデフレートされており、最初にタイプを示すタグとデータに関するサイズ情報から始まります。SHA1ハッシュは常に圧縮されたオブジェクトのハッシュであり、元のオブジェクトのハッシュではありません。

特に、オブジェクトの整合性は、その内容やタイプとは無関係に常にテストできます。すべてのオブジェクトは、以下のことを確認することで検証できます。(a)それらのハッシュがファイルの内容と一致すること、および(b)オブジェクトが正常にインフレートされて、<スペースなしのASCIIタグ> + <スペース> + <ASCII 10進サイズ> + <byte\0> + <バイナリオブジェクトデータ>のシーケンスを形成するバイトストリームになること。

💡 オブジェクトの種類
BLOB: 「blob」オブジェクトは、データのバイナリの塊に過ぎず、他には何も参照しません。データにはシグネチャやその他の検証はありません。したがって、オブジェクトは一貫していますが（そのsha1ハッシュによってインデックス付けされているため、データ自体は確かに正しい）、他の属性は一切ありません。名前の関連付けも、パーミッションもありません。それは純粋なデータの塊（つまり通常は「ファイルの内容」）です。

TREE: 次の階層的なオブジェクトタイプは「tree」オブジェクトです。ツリーオブジェクトは、パーミッション/名前/blobデータのリストであり、名前でソートされています。言い換えれば、ツリーオブジェクトはセットの内容によって一意に決定されるため、別個であっても同一の2つのツリーは、常にまったく同じオブジェクトを共有します。

繰り返しますが、「tree」オブジェクトは単なる純粋なデータ抽象化です。履歴も、シグネチャも、有効性の検証もありません。ただし、その内容はハッシュ自体によって保護されています。したがって、blobの内容を信頼できるのと同じ方法で、ツリーの内容を信頼できますが、それらの内容がどこから来たのかはわかりません。

ツリーに関する補足: 「tree」オブジェクトは「ファイル名+内容」のソートされたリストであるため、2つのツリーを実際にアンパックすることなく、それらの間の差分（diff）を作成できます。共通の部分を無視するだけで、差分は正しく見えます。言い換えれば、ツリーのサイズではなく、差分のサイズである$O(n)$で、任意の2つのツリー間の違いを効果的（かつ効率的）に判断できます。

ツリーに関する補足2: 「blob」の名前はその内容のみに依存する（つまり、名前やパーミッションは関与しない）ため、blobが同じままであることに気付くことで、些細な名前の変更やパーミッションの変更を確認できます。ただし、データ変更を伴う名前変更には、よりスマートな「diff」の実装が必要です。

CHANGESET (変更セット): 「changeset」オブジェクトは、状況に履歴の概念を導入するオブジェクトです。他のオブジェクトとは対照的に、ツリーの物理的な状態を記述するだけでなく、どのようにそこに到達したか、そしてその理由を記述します。

「changeset」は、それが結果として生じるツリーオブジェクト、その時点に至るまでの親の変更セット（ゼロ、1つ、またはそれ以上）、および何が起こったかについてのコメントによって定義されます。繰り返しますが、変更セットはそれ自体は信頼されていません。すべてのレベルでの暗号学的に強力なシグネチャのおかげで、内容は明確に定義されており「安全」ですが、ツリーが「良好」であるとか、マージ情報が理にかなっていると信じる理由はありません。たとえば、親が結果と実際に何らかの関係を持っている必要はありません。

変更セットに関する注意: 真のSCM（構成管理システム）とは異なり、変更セットには名前変更情報やファイルモード変更情報は含まれていません。それらすべては、関連するツリー（結果ツリー、および親の結果ツリー）に暗黙的に含まれており、この馬鹿げたファイルマネージャーでそれを記述することは意味がありません。

🛡️ 信頼（TRUST）
「信頼」の概念は「git」の範囲外ですが、いくつか留意すべき点があります。まず、すべてがSHA1でハッシュ化されているため、オブジェクトが無傷であり、外部ソースによって改ざんされていないことを信頼できます。したがって、オブジェクトの名前は、既知の状態を一意に識別しますが、それはあなたが信頼したい状態ではないかもしれません。

さらに、変更セットのSHA1シグネチャは、それに関連付けられたツリーのSHA1シグネチャと親のシグネチャを参照するため、単一の名前付き変更セットは、完全な内容を持つ一連の履歴全体を一意に指定します。変更セットの名前がわかれば、後で途中のどのステップも偽造することはできません。

したがって、システムに実際の信頼を導入するために必要なのは、トップレベルの変更セットの名前を含む1つの特別なメモをデジタル署名することだけです。あなたのデジタル署名は、あなたがその変更セットを信頼していることを他の人に示し、変更セットの履歴の不変性が、他の人に履歴全体を信頼できることを伝えます。

言い換えれば、トップの変更セットの名前（SHA1ハッシュ）を人々に伝え、GPG/PGPのようなものを使用してそのメールにデジタル署名する単一のメールを送信するだけで、アーカイブ全体を簡単に検証できます。

特に、「信頼ポイント」またはタグの個別のアーカイブを持つこともでき、これはあなた（および他の人々）の信頼を文書化します。もちろん、これらの「信頼の証明書」を「git」自体を使用してアーカイブすることもできますが、それは「git」があなたのために行うことではありません。

同じことを別の言い方で言えば、「git」自体はコンテンツの整合性のみを処理し、信頼は外部からもたらされなければなりません。

📁 現在のディレクトリキャッシュ（.dircache/index）
「現在のディレクトリキャッシュ」は、ある任意の時点での仮想ディレクトリコンテンツの効率的な表現を含む単純なバイナリファイルです。これは、名前、日付、パーミッション、およびコンテンツ（別名「blob」）オブジェクトのセットを関連付ける単純な配列によって行われます。キャッシュは常に名前で順序付けられて保持され、名前はいつでも一意ですが、キャッシュには長期的な意味はなく、いつでも部分的に更新できます。

特に、「現在のディレクトリキャッシュ」は、現在のディレクトリの内容と一致している必要はありませんが、2つの非常に重要な属性を持っています。

(a) キャッシュしている完全な状態を再生成できます（ディレクトリ構造だけでなく、「blob」オブジェクトを介してデータも再生成できます）。

特別なケースとして、現在のディレクトリキャッシュから「treeオブジェクト」への明確で曖昧さのない一方向のマッピングがあり、他のデータを実際に見ることなく、現在のディレクトリキャッシュから効率的に作成できます。したがって、ディレクトリキャッシュは任意の時点で一意に1つだけの「tree」オブジェクトを指定します（ただし、ディレクトリで何が起こったかとそのtreeオブジェクトを簡単に照合するための追加データを持っています）。

(b) そのキャッシュされた状態（「インスタンス化を待っているtreeオブジェクト」）と現在の状態との間の不整合を見つけるための効率的なメソッドを持っています。

これらが、ディレクトリキャッシュが行う唯一の2つのことです。これはキャッシュであり、通常の操作は、既知のtreeオブジェクトから完全に再生成するか、開発中のライブツリーと更新/比較することです。記述していたツリーの名前がわかっている限り、ディレクトリキャッシュを完全に吹き飛ばしても、情報は失われません。

（しかし、ディレクトリキャッシュには実際の情報も含まれている可能性があります。特に、まだインスタンス化されていない中間ツリーの表現を持つことができます。したがって、これらはキャッシュの外部でも意味と用途があります。ある意味では、現在のディレクトリキャッシュを、ツリーコミットに向けた「進行中の作業」と考えることができます。）
